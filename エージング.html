<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earphone Performance Lab v3.0 | ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°ï¼†æ€§èƒ½è¨ºæ–­</title>
    <meta name="description" content="ã‚¤ãƒ¤ãƒ›ãƒ³ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’è§£æ”¾ã›ã‚ˆã€‚ã‚¿ã‚¤ãƒãƒ¼ä»˜ãã‚¨ãƒ¼ã‚¸ãƒ³ã‚°ã€å‘¨æ³¢æ•°ã‚¹ã‚¤ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆã€å®šä½ãƒ»ä½ç›¸ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹ãƒ—ãƒ­ä»•æ§˜ãƒ„ãƒ¼ãƒ«ã€‚">
    
    <!-- OGP -->
    <meta property="og:title" content="Earphone Performance Lab v3.0">
    <meta property="og:description" content="ã‚ãªãŸã®ã‚¤ãƒ¤ãƒ›ãƒ³ã¯20Hzã®é‡ä½éŸ³ã‚’å†ç”Ÿã§ãã¾ã™ã‹ï¼Ÿã‚¨ãƒ¼ã‚¸ãƒ³ã‚°ã‹ã‚‰é™ç•Œãƒ†ã‚¹ãƒˆã¾ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Œçµã€‚">
    <meta name="twitter:card" content="summary_large_image">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Inter"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
                    colors: { brand: { bg: '#050505', surface: '#121212', accent: '#00dc82', text: '#f3f4f6' } },
                    animation: { 
                        'pulse-fast': 'pulse 0.5s infinite',
                        'scan': 'scan 3s linear infinite'
                    },
                    keyframes: { 
                        scan: { '0%': { transform: 'translateY(-100%)' }, '100%': { transform: 'translateY(100%)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #f3f4f6; }
        .glass-panel { background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); box-shadow: 0 0 40px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        
        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #00dc82; cursor: pointer; margin-top: -10px;
            box-shadow: 0 0 15px rgba(0, 220, 130, 0.8); border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
        }

        .visualizer-container { display: flex; align-items: flex-end; justify-content: center; gap: 2px; height: 40px; }
        .v-bar { width: 4px; background: #333; border-radius: 2px; transition: height 0.1s; }
        .active .v-bar { background: #00dc82; box-shadow: 0 0 10px #00dc82; }

        .btn-primary {
            background: #00dc82; color: #000; font-weight: bold;
            transition: all 0.2s; border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(0, 220, 130, 0.6); }
        .btn-secondary {
            background: transparent; color: #fff; font-weight: bold;
            border: 1px solid rgba(255,255,255,0.2); transition: all 0.2s;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
        
        .tab-btn {
            padding: 8px 16px; font-size: 12px; font-weight: bold; border-radius: 9999px;
            background: #222; color: #888; border: 1px solid #333; transition: all 0.2s;
        }
        .tab-btn.active {
            background: #00dc82; color: #000; border-color: #00dc82; box-shadow: 0 0 10px rgba(0,220,130,0.4);
        }

        .scan-line { position: absolute; left: 0; top: 0; width: 100%; height: 2px; background: rgba(0, 220, 130, 0.5); box-shadow: 0 0 10px #00dc82; animation: scan 3s linear infinite; pointer-events: none; opacity: 0; }
        .scanning .scan-line { opacity: 1; }
        
        .timer-display { font-family: 'JetBrains Mono', monospace; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center font-sans selection:bg-emerald-500 selection:text-white pb-20">

    <!-- Warning Header -->
    <div class="w-full bg-yellow-500/10 border-b border-yellow-500/20 px-4 py-2 text-center">
        <p class="text-xs text-yellow-500 font-mono font-bold flex items-center justify-center gap-2">
            <i data-lucide="volume-2" class="w-4 h-4"></i>
            WARNING: Set volume to LOW before testing.
        </p>
    </div>

    <!-- Main Content -->
    <div class="w-full max-w-3xl px-4 mt-8">
        
        <!-- Header -->
        <div class="text-center mb-10">
            <div class="inline-flex items-center gap-2 mb-2 text-[#00dc82]">
                <i data-lucide="waves" class="w-6 h-6"></i>
                <span class="font-mono font-bold tracking-widest">EARPHONE LAB v3.0</span>
            </div>
            <h1 class="text-3xl md:text-5xl font-black mb-4 leading-tight text-white">
                ãã®ã‚¤ãƒ¤ãƒ›ãƒ³ã€<span class="text-[#00dc82]">è¦šé†’</span>ã•ã›ã‚‹ã€‚
            </h1>
            <p class="text-brand-muted text-sm md:text-base">
                ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»ã‚¿ã‚¤ãƒãƒ¼ã€å‘¨æ³¢æ•°ã‚¹ã‚¤ãƒ¼ãƒ—ã€ä½ç›¸ãƒã‚§ãƒƒã‚¯æ­è¼‰ã€‚<br>
                ãƒ—ãƒ­ä»•æ§˜ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã€‚
            </p>
        </div>

        <!-- Tool 1: Burn-in (Aging) -->
        <div class="glass-panel rounded-2xl p-6 md:p-8 mb-8" id="burnin-panel">
            <div class="scan-line"></div>
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl font-bold flex items-center gap-2 text-white">
                    <i data-lucide="zap" class="text-[#00dc82]"></i>
                    BURN-IN (ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°)
                </h2>
                <!-- Noise Type Selector -->
                <div class="flex gap-2 bg-black/50 p-1 rounded-full border border-white/10">
                    <button onclick="setNoise('pink')" id="btn-pink" class="tab-btn active">PINK</button>
                    <button onclick="setNoise('white')" id="btn-white" class="tab-btn">WHITE</button>
                    <button onclick="setNoise('brown')" id="btn-brown" class="tab-btn">BROWN</button>
                </div>
            </div>
            
            <!-- Timer Settings -->
            <div class="mb-6">
                <p class="text-xs text-brand-muted mb-2 font-bold uppercase tracking-wider">TIMER SETTINGS</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setTimer(0)" class="time-btn active bg-[#00dc82]/10 border border-[#00dc82] text-[#00dc82] px-3 py-1 rounded text-xs font-bold" data-time="0">âˆ ç„¡é™</button>
                    <button onclick="setTimer(15)" class="time-btn bg-white/5 border border-white/10 text-brand-muted hover:text-white px-3 py-1 rounded text-xs" data-time="15">15åˆ†</button>
                    <button onclick="setTimer(30)" class="time-btn bg-white/5 border border-white/10 text-brand-muted hover:text-white px-3 py-1 rounded text-xs" data-time="30">30åˆ†</button>
                    <button onclick="setTimer(60)" class="time-btn bg-white/5 border border-white/10 text-brand-muted hover:text-white px-3 py-1 rounded text-xs" data-time="60">60åˆ†</button>
                    <button onclick="setTimer(120)" class="time-btn bg-white/5 border border-white/10 text-brand-muted hover:text-white px-3 py-1 rounded text-xs" data-time="120">2æ™‚é–“</button>
                </div>
            </div>

            <!-- Timer Display -->
            <div class="text-center mb-6 py-4 bg-black/40 rounded-xl border border-white/5">
                <div class="text-xs text-brand-muted mb-1">ELAPSED TIME</div>
                <div class="text-5xl font-black text-white timer-display tracking-widest" id="timer-display">00:00:00</div>
                <div class="text-xs text-[#00dc82] mt-1 h-4" id="timer-status"></div>
            </div>

            <!-- Visualizer -->
            <div class="visualizer-container mb-6" id="burnin-vis"></div>

            <button onclick="toggleBurnIn()" id="burnin-btn" class="w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 btn-secondary">
                <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                <span id="burnin-btn-text">ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°é–‹å§‹</span>
            </button>
        </div>

        <!-- Tool 2: Frequency Range Test -->
        <div class="glass-panel rounded-2xl p-6 md:p-8 mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-white">
                <i data-lucide="activity" class="text-blue-400"></i>
                RANGE TEST (å†ç”Ÿèƒ½åŠ›)
            </h2>
            
            <div class="text-center mb-8 relative">
                <div class="text-6xl font-black font-mono tracking-tighter mb-2 text-white timer-display" id="freq-display">1,000<span class="text-2xl text-brand-muted ml-2">Hz</span></div>
                <div class="inline-block bg-white/10 px-4 py-1 rounded-full text-sm font-bold text-blue-400 border border-white/10" id="range-label">
                    ä¸­éŸ³åŸŸ (Mid)
                </div>
            </div>

            <div class="px-2 mb-8">
                <input type="range" id="freq-slider" min="20" max="20000" step="10" value="1000" oninput="updateFreq(this.value)">
                <div class="flex justify-between text-[10px] text-brand-muted font-mono mt-3 uppercase" id="freq-labels">
                    <span>20Hz</span><span>1k</span><span>10k</span><span>20k</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <button id="tone-btn" onclick="toggleTone()" class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 btn-secondary">
                    <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                    <span id="tone-text">ãƒˆãƒ¼ãƒ³å†ç”Ÿ</span>
                </button>
                <button id="sweep-btn" onclick="toggleSweep()" class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 btn-secondary bg-blue-500/10 border-blue-500/30 hover:bg-blue-500/20 text-blue-300">
                    <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                    <span id="sweep-text">Auto Sweep (20-20k)</span>
                </button>
            </div>
            
            <button onclick="unlockHiRes()" id="unlock-btn" class="w-full text-xs text-[#00dc82] hover:text-white border border-[#00dc82]/30 hover:border-[#00dc82] rounded-lg py-2 transition-all flex items-center justify-center gap-2 mt-2">
                <i data-lucide="zap" class="w-3 h-3"></i>
                é«˜ç´šã‚¤ãƒ¤ãƒ›ãƒ³è‡ªæ…¢ãƒ¢ãƒ¼ãƒ‰ (Unlock 50kHz)
            </button>

            <p class="text-xs text-brand-muted text-center mt-4">
                â€» 20Hzã€œ50Hzã¯ã€Œè€³ã€ã§ã¯ãªãã€ŒæŒ¯å‹•ã€ã§æ„Ÿã˜ã¦ãã ã•ã„ã€‚
            </p>
        </div>

        <!-- Tool 3: Stereo & Imaging -->
        <div class="glass-panel rounded-2xl p-6 md:p-8 mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-white">
                <i data-lucide="move-horizontal" class="text-purple-400"></i>
                STEREO / IMAGING (å®šä½)
            </h2>
            
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button onmousedown="playStereo('left')" onmouseup="stopStereo()" ontouchstart="playStereo('left')" ontouchend="stopStereo()" class="h-24 rounded-xl border border-white/10 hover:bg-white/5 active:bg-blue-500/20 transition-all flex flex-col items-center justify-center gap-1 group">
                    <span class="text-4xl font-black text-brand-muted group-active:text-blue-400 transition-all">L</span>
                    <span class="text-[10px] font-mono text-brand-muted">Left</span>
                </button>
                <button onmousedown="playStereo('center')" onmouseup="stopStereo()" ontouchstart="playStereo('center')" ontouchend="stopStereo()" class="h-24 rounded-xl border border-white/10 hover:bg-white/5 active:bg-purple-500/20 transition-all flex flex-col items-center justify-center gap-1 group">
                    <span class="text-4xl font-black text-brand-muted group-active:text-purple-400 transition-all">C</span>
                    <span class="text-[10px] font-mono text-brand-muted">Center (Mono)</span>
                </button>
                <button onmousedown="playStereo('right')" onmouseup="stopStereo()" ontouchstart="playStereo('right')" ontouchend="stopStereo()" class="h-24 rounded-xl border border-white/10 hover:bg-white/5 active:bg-red-500/20 transition-all flex flex-col items-center justify-center gap-1 group">
                    <span class="text-4xl font-black text-brand-muted group-active:text-red-400 transition-all">R</span>
                    <span class="text-[10px] font-mono text-brand-muted">Right</span>
                </button>
            </div>

            <button onclick="startPanning()" id="pan-btn" class="w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 btn-secondary mb-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                <span id="pan-text">å®šä½ç§»å‹•ãƒ†ã‚¹ãƒˆ (L â†” R)</span>
            </button>
            
            <div class="w-full h-2 bg-gray-800 rounded-full mt-4 relative overflow-hidden">
                <div id="pan-indicator" class="absolute top-0 left-1/2 w-4 h-full bg-purple-500 rounded-full transform -translate-x-1/2 transition-all duration-75 opacity-0"></div>
            </div>
        </div>

        <!-- Affiliate / Share -->
        <div class="text-center mt-12">
            <div class="bg-gradient-to-r from-green-500/10 to-blue-500/10 border border-white/10 rounded-2xl p-8 mb-8">
                <h3 class="text-lg font-bold mb-2 text-white">ã€Œä½éŸ³ãŒèã“ãˆãªã„ã€ã€Œå·¦å³ãŒã‚ºãƒ¬ã¦ã‚‹ï¼Ÿã€</h3>
                <p class="text-sm text-brand-muted mb-6">
                    ãã‚Œã¯ã‚¤ãƒ¤ãƒ›ãƒ³ã®å¯¿å‘½ã‹ã€æ€§èƒ½é™ç•Œã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<br>
                    ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å¾„ã®å¤§ãã„ã‚¤ãƒ¤ãƒ›ãƒ³ã‚„ã€ãƒã‚¤ãƒ¬ã‚¾å¯¾å¿œæ©Ÿã§ä¸–ç•ŒãŒå¤‰ã‚ã‚Šã¾ã™ã€‚
                </p>
                <div id="rec-container" class="grid gap-4 text-left mb-8"></div>

                <div class="pt-6 border-t border-white/10">
                    <p class="text-xs text-brand-muted mb-3 font-mono">STILL LOOKING FOR THE BEST GEAR?</p>
                    <a href="https://art2020k.github.io/my-gadget-tools/ã‚¤ãƒ¤ãƒ›ãƒ³è¨ºæ–­.html" class="group relative inline-flex items-center justify-center px-6 py-3 font-bold text-[#00dc82] transition-all duration-200 border border-[#00dc82]/30 rounded-lg hover:bg-[#00dc82]/10 hover:border-[#00dc82] hover:shadow-[0_0_15px_rgba(0,220,130,0.2)] w-full md:w-auto">
                        <i data-lucide="search" class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform"></i>
                        <span>è‡ªåˆ†ã«åˆã†ã‚¤ãƒ¤ãƒ›ãƒ³ã‚’è¨ºæ–­ã™ã‚‹</span>
                        <i data-lucide="arrow-right" class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </a>
                </div>
            </div>

            <button onclick="shareResult()" class="bg-black border border-white/20 hover:bg-white/10 text-white px-8 py-3 rounded-full text-sm font-bold transition-all flex items-center justify-center gap-2 mx-auto mb-4">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ã‚·ã‚§ã‚¢
            </button>
            <p class="text-[10px] text-brand-muted">#ã‚¤ãƒ¤ãƒ›ãƒ³ã‚¨ãƒ¼ã‚¸ãƒ³ã‚° #å¯è´åŸŸãƒã‚§ãƒƒã‚¯</p>
        </div>

    </div>

    <script>
        lucide.createIcons();
        const AFFILIATE_ID = 'artphotograph-22';

        // --- Audio System ---
        let audioCtx;
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // --- 1. Burn-in System ---
        let burnNode = null;
        let isBurnIn = false;
        let noiseType = 'pink';
        let targetTime = 0; // minutes, 0=infinite
        let startTime = 0;
        let timerInterval = null;

        function setNoise(type) {
            noiseType = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
            if (isBurnIn) { toggleBurnIn(); toggleBurnIn(); } // Restart if running
        }

        function setTimer(minutes) {
            targetTime = minutes;
            document.querySelectorAll('.time-btn').forEach(b => {
                b.classList.remove('active', 'bg-[#00dc82]/10', 'border-[#00dc82]', 'text-[#00dc82]');
                b.classList.add('bg-white/5', 'border-white/10', 'text-brand-muted');
                if (parseInt(b.dataset.time) === minutes) {
                    b.classList.remove('bg-white/5', 'border-white/10', 'text-brand-muted');
                    b.classList.add('active', 'bg-[#00dc82]/10', 'border-[#00dc82]', 'text-[#00dc82]');
                }
            });
            document.getElementById('timer-status').textContent = minutes === 0 ? "TARGET: INFINITE" : `TARGET: ${minutes} MIN`;
        }

        function createNoise(type) {
            const bufferSize = 4096;
            const node = audioCtx.createScriptProcessor(bufferSize, 1, 1);
            
            // State for Pink/Brown
            let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0; 
            let lastOut = 0;

            node.onaudioprocess = function(e) {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    
                    if (type === 'white') {
                        output[i] = white * 0.1;
                    } else if (type === 'pink') {
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                        b6 = white * 0.115926;
                    } else if (type === 'brown') {
                        let brown = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = brown;
                        output[i] = brown * 3.5; 
                    }
                }
            };
            return node;
        }

        function toggleBurnIn() {
            initAudio();
            const btn = document.getElementById('burnin-btn');
            const panel = document.getElementById('burnin-panel');
            const vis = document.getElementById('burnin-vis');

            if (isBurnIn) {
                // STOP
                if (burnNode) { burnNode.disconnect(); burnNode = null; }
                isBurnIn = false;
                clearInterval(timerInterval);
                btn.classList.replace('btn-primary', 'btn-secondary');
                btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 fill-current"></i><span>ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°é–‹å§‹</span>';
                panel.classList.remove('scanning');
                vis.classList.remove('active');
                lucide.createIcons();
            } else {
                // START
                burnNode = createNoise(noiseType);
                burnNode.connect(audioCtx.destination);
                isBurnIn = true;
                startTime = Date.now();
                
                // Timer Logic
                timerInterval = setInterval(() => {
                    const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
                    const hrs = Math.floor(elapsedSec / 3600).toString().padStart(2, '0');
                    const mins = Math.floor((elapsedSec % 3600) / 60).toString().padStart(2, '0');
                    const secs = (elapsedSec % 60).toString().padStart(2, '0');
                    document.getElementById('timer-display').textContent = `${hrs}:${mins}:${secs}`;

                    // Auto Stop
                    if (targetTime > 0 && elapsedSec >= targetTime * 60) {
                        toggleBurnIn();
                        alert('ã‚¨ãƒ¼ã‚¸ãƒ³ã‚°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    }
                }, 1000);

                btn.classList.replace('btn-secondary', 'btn-primary');
                btn.innerHTML = '<i data-lucide="square" class="w-5 h-5 fill-current"></i><span>åœæ­¢</span>';
                panel.classList.add('scanning');
                vis.classList.add('active');
                lucide.createIcons();
            }
        }

        // Init Visualizer
        const vis = document.getElementById('burnin-vis');
        for(let i=0; i<30; i++) {
            const d = document.createElement('div');
            d.className='v-bar'; d.style.height='4px'; vis.appendChild(d);
        }
        function animVis() {
            if(isBurnIn) {
                document.querySelectorAll('.v-bar').forEach(b => b.style.height = Math.random()*30+4+'px');
            }
            requestAnimationFrame(animVis);
        }
        animVis();

        // --- 2. Tone & Sweep ---
        let toneOsc = null;
        let isTone = false;
        let isSweep = false;
        let sweepInterval = null;

        function updateFreq(val) {
            const freq = parseInt(val);
            document.getElementById('freq-display').innerHTML = `${freq.toLocaleString()}<span class="text-2xl text-brand-muted ml-2">Hz</span>`;
            if (isTone && toneOsc) toneOsc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            let label="", color="text-brand-muted";
            if(freq<60){ label="Sub-Bass"; color="text-purple-400"; }
            else if(freq<250){ label="Bass"; color="text-blue-400"; }
            else if(freq<2000){ label="Midrange"; color="text-green-400"; }
            else if(freq<6000){ label="High-Mid"; color="text-yellow-400"; }
            else if(freq<20000){ label="Treble"; color="text-orange-400"; }
            else { label="God Tier (ã‚³ã‚¦ãƒ¢ãƒªç´š)"; color="text-[#00dc82] animate-pulse"; }
            
            const badge = document.getElementById('range-label');
            badge.textContent = label;
            badge.className = `inline-block bg-white/10 px-4 py-1 rounded-full text-sm font-bold border border-white/10 ${color}`;
        }

        function toggleTone() {
            if(isSweep) toggleSweep(); // Stop sweep if running
            initAudio();
            const btn = document.getElementById('tone-btn');
            const val = document.getElementById('freq-slider').value;

            if (isTone) {
                toneOsc.stop(); toneOsc = null; isTone = false;
                btn.classList.replace('btn-primary', 'btn-secondary');
                document.getElementById('tone-text').textContent = 'ãƒˆãƒ¼ãƒ³å†ç”Ÿ';
            } else {
                toneOsc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                toneOsc.type = 'sine';
                toneOsc.frequency.value = val;
                g.gain.value = 0.1;
                toneOsc.connect(g); g.connect(audioCtx.destination);
                toneOsc.start();
                isTone = true;
                btn.classList.replace('btn-secondary', 'btn-primary');
                document.getElementById('tone-text').textContent = 'åœæ­¢';
            }
        }

        function toggleSweep() {
            if(isTone) toggleTone(); // Stop tone if running
            initAudio();
            const btn = document.getElementById('sweep-btn');
            
            if (isSweep) {
                // Stop
                if(toneOsc) { toneOsc.stop(); toneOsc = null; }
                clearInterval(sweepInterval);
                isSweep = false;
                btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                btn.classList.add('bg-blue-500/10', 'text-blue-300');
                document.getElementById('sweep-text').textContent = 'Auto Sweep (20-20k)';
            } else {
                // Start Logarithmic Sweep (10s)
                toneOsc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                toneOsc.type = 'sine';
                toneOsc.frequency.value = 20;
                g.gain.value = 0.1;
                toneOsc.connect(g); g.connect(audioCtx.destination);
                toneOsc.start();
                
                isSweep = true;
                btn.classList.remove('bg-blue-500/10', 'text-blue-300');
                btn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                document.getElementById('sweep-text').textContent = 'ã‚¹ã‚¤ãƒ¼ãƒ—ä¸­... (åœæ­¢)';

                let startF = 20;
                let endF = 20000;
                let duration = 10000; // 10s
                let startT = Date.now();

                sweepInterval = setInterval(() => {
                    let elapsed = Date.now() - startT;
                    if(elapsed >= duration) { toggleSweep(); return; }
                    
                    // Logarithmic scale formula
                    let freq = startF * Math.pow(endF / startF, elapsed / duration);
                    toneOsc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    
                    // Update UI Slider
                    const slider = document.getElementById('freq-slider');
                    slider.value = freq;
                    updateFreq(freq);
                }, 20);
            }
        }

        function unlockHiRes() {
            const s = document.getElementById('freq-slider');
            const b = document.getElementById('unlock-btn');
            const l = document.getElementById('freq-labels');
            if(s.max == 20000) {
                s.max = 50000;
                b.innerHTML = '<i data-lucide="lock" class="w-3 h-3"></i> é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™';
                b.classList.add('bg-[#00dc82]/10');
                l.innerHTML = `<span>20</span><span>1k</span><span>10k</span><span>20k</span><span class="text-[#00dc82]">50k</span>`;
            } else {
                s.max = 20000;
                if(s.value > 20000) { s.value = 20000; updateFreq(20000); }
                b.innerHTML = '<i data-lucide="zap" class="w-3 h-3"></i> é«˜ç´šã‚¤ãƒ¤ãƒ›ãƒ³è‡ªæ…¢ãƒ¢ãƒ¼ãƒ‰ (Unlock 50kHz)';
                b.classList.remove('bg-[#00dc82]/10');
                l.innerHTML = `<span>20</span><span>100</span><span>1k</span><span>10k</span><span>20k</span>`;
            }
            lucide.createIcons();
        }

        // --- 3. Stereo ---
        let stOsc, panOsc, isPan = false;

        function playStereo(pos) {
            initAudio();
            stOsc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            const p = audioCtx.createStereoPanner();
            stOsc.type = 'sine'; stOsc.frequency.value = 440; g.gain.value = 0.1;
            
            let panVal = 0;
            if(pos==='left') panVal = -1;
            if(pos==='right') panVal = 1;
            p.pan.value = panVal;

            stOsc.connect(g); g.connect(p); p.connect(audioCtx.destination);
            stOsc.start();
        }
        function stopStereo() { if(stOsc) { stOsc.stop(); stOsc = null; } }

        function startPanning() {
            initAudio();
            const btn = document.getElementById('pan-btn');
            const ind = document.getElementById('pan-indicator');
            if(isPan) {
                panOsc.stop(); panOsc=null; isPan=false;
                btn.classList.replace('btn-primary', 'btn-secondary');
                document.getElementById('pan-text').textContent = 'å®šä½ç§»å‹•ãƒ†ã‚¹ãƒˆ (L â†” R)';
                ind.style.opacity = 0;
            } else {
                panOsc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                const p = audioCtx.createStereoPanner();
                panOsc.frequency.value = 800; g.gain.value = 0.1;
                panOsc.connect(g); g.connect(p); p.connect(audioCtx.destination);
                panOsc.start();
                
                isPan = true;
                btn.classList.replace('btn-secondary', 'btn-primary');
                document.getElementById('pan-text').textContent = 'åœæ­¢';
                ind.style.opacity = 1;
                
                let start = audioCtx.currentTime;
                function loop() {
                    if(!isPan) return;
                    let pos = Math.sin((audioCtx.currentTime - start) * 2);
                    p.pan.value = pos;
                    ind.style.left = ((pos + 1) / 2 * 100) + '%';
                    requestAnimationFrame(loop);
                }
                loop();
            }
        }

        // --- Affiliate ---
        const recItems = [
            { name: "Sennheiser IE 200", desc: "ã€æœ‰ç·šã€‘åŸéŸ³å†ç”Ÿã®åŸºæº–æ©Ÿã€‚ã“ã®ä¾¡æ ¼ã§ã“ã®è§£åƒåº¦ã¯åå‰‡ç´šã€‚", kw: "Sennheiser IE 200", price: "Â¥23,000" },
            { name: "Sony WH-1000XM5", desc: "ã€ç„¡ç·šã€‘æ¥­ç•Œæœ€é«˜å³°ã®ãƒã‚¤ã‚­ãƒ£ãƒ³ã¨éŸ³è³ªã€‚è€³ã®é™ç•Œã‚’è©¦ã™ãªã‚‰ã“ã‚Œã€‚", kw: "Sony WH-1000XM5", price: "Â¥48,000" },
            { name: "Moondrop Aria 2", desc: "ã€ä¸­è¯ã€‘1ä¸‡å††å°ã®è¦‡æ¨©ã€‚ãƒœãƒ¼ã‚«ãƒ«ã®æ¯é£ã„ã¾ã§è´ã“ãˆã‚‹ç¾éŸ³ã€‚", kw: "Moondrop Aria 2", price: "Â¥13,500" }
        ];
        const recC = document.getElementById('rec-container');
        recItems.forEach(i => {
            const u = `https://www.amazon.co.jp/s?k=${encodeURIComponent(i.kw)}&tag=${AFFILIATE_ID}`;
            recC.innerHTML += `<a href="${u}" target="_blank" class="flex items-center justify-between p-4 bg-white/5 border border-white/10 rounded-xl hover:border-[#00dc82]/50 transition-all group"><div class="text-left"><div class="font-bold text-white group-hover:text-[#00dc82] transition-colors">${i.name}</div><div class="text-xs text-brand-muted">${i.desc}</div></div><div class="text-right flex flex-col items-end"><div class="text-xs font-mono text-brand-muted mb-1">${i.price}</div><i data-lucide="external-link" class="w-4 h-4 text-white"></i></div></a>`;
        });

        function shareResult() {
            const url = "https://Art2020k.github.io/Gadget/EarphoneLab.html";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("ã€Earphone Labã€‘ã‚¤ãƒ¤ãƒ›ãƒ³ã®æ¥µé™ãƒ†ã‚¹ãƒˆå®Ÿæ–½ä¸­...ğŸ§\n#ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒã‚§ãƒƒã‚¯")}&url=${encodeURIComponent(url)}`, '_blank');
        }
    </script>
</body>
</html>
