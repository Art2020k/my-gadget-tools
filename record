<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nordic Vinyl Jazz Player</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">

    <style>
        :root {
            --record-speed: 1.8s; /* 33 1/3 RPM calculation: 60s / 33.333... = 1.8s */
            --wood-color: #d4c5b0;
            --wood-dark: #bba98e;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: #f2f0eb;
            background-image: 
                radial-gradient(at 0% 0%, rgba(200, 200, 200, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(200, 200, 200, 0.1) 0px, transparent 50%);
            overflow: hidden; /* Prevent scroll on mobile */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Vinyl Record Grooves */
        .vinyl-grooves {
            background: 
                repeating-radial-gradient(
                #1a1a1a, 
                #1a1a1a 2px, 
                #000 3px, 
                #000 4px
                );
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.1),
                0 10px 30px rgba(0,0,0,0.4);
        }

        /* Realistic Gloss reflection on vinyl */
        .vinyl-gloss {
            background: conic-gradient(
                transparent 0deg,
                rgba(255, 255, 255, 0.1) 20deg,
                transparent 40deg,
                transparent 140deg,
                rgba(255, 255, 255, 0.1) 160deg,
                transparent 180deg,
                transparent 360deg
            );
            border-radius: 50%;
        }

        /* Rotation Animation */
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin var(--record-speed) linear infinite;
        }

        .paused-spin {
            animation-play-state: paused;
        }

        /* Tone Arm Animation Classes */
        .arm-container {
            transform-origin: 50% 15%; /* Pivot point at the base */
            transition: transform 1.5s ease-in-out;
            transform: rotate(-35deg); /* Default Rest Position */
        }
        
        .arm-container.playing {
            transform: rotate(22deg); /* Playing Position */
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4b5563;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #d1d5db;
            border-radius: 2px;
        }

        /* Vintage Typography */
        .vintage-font {
            font-family: 'Cinzel', serif;
        }

        /* Wood Texture Overlay */
        .wood-texture {
            background-color: #f3f4f6;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* Hidden YouTube but accessible for API */
        #player {
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center text-gray-800 relative">

    <!-- Decorative Background Elements -->
    <div class="absolute inset-0 pointer-events-none z-0 flex justify-center items-center">
        <div class="w-[80vw] h-[80vw] max-w-[600px] max-h-[600px] rounded-full border border-gray-300 opacity-30"></div>
        <div class="absolute w-[60vw] h-[60vw] max-w-[450px] max-h-[450px] rounded-full border border-gray-300 opacity-20"></div>
    </div>

    <!-- Main Player Unit -->
    <div class="z-10 relative bg-white/80 backdrop-blur-md shadow-2xl rounded-3xl p-6 md:p-10 w-full max-w-md md:max-w-2xl flex flex-col md:flex-row items-center gap-8 border border-white/50 wood-texture">
        
        <!-- Turntable Area -->
        <div class="relative w-72 h-72 md:w-80 md:h-80 flex-shrink-0">
            <!-- Base Platter -->
            <div class="absolute inset-0 rounded-full bg-gray-200 shadow-inner border border-gray-300"></div>

            <!-- The Record -->
            <div id="record" class="absolute inset-2 rounded-full vinyl-grooves flex items-center justify-center shadow-xl transition-transform duration-1000">
                <!-- Gloss Effect -->
                <div class="absolute inset-0 vinyl-gloss z-10"></div>
                
                <!-- Label (Thumbnail) -->
                <div class="relative z-20 w-28 h-28 rounded-full overflow-hidden border-4 border-[#c2b280] bg-gray-800 shadow-md flex items-center justify-center bg-black">
                    <img id="album-art" src="https://i.ytimg.com/vi/DWcJFNfaw9c/hqdefault.jpg" alt="Album Art" class="w-full h-full object-cover opacity-90 transition-opacity duration-300">
                    <!-- Loading/Error Overlay -->
                    <div id="label-status" class="absolute inset-0 flex items-center justify-center bg-black/60 text-white text-[10px] font-bold tracking-widest uppercase hidden text-center p-1">
                        Loading...
                    </div>
                    <!-- Spindle Hole -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-2 h-2 bg-black rounded-full border border-gray-500"></div>
                </div>
            </div>

            <!-- Tone Arm Construction -->
            <div id="tone-arm" class="arm-container absolute -top-8 -right-8 w-24 h-64 pointer-events-none z-30">
                <!-- Pivot Base -->
                <div class="absolute top-8 left-1/2 transform -translate-x-1/2 w-16 h-16 rounded-full bg-gradient-to-br from-gray-200 to-gray-400 shadow-lg border border-gray-300 flex items-center justify-center">
                    <div class="w-4 h-4 rounded-full bg-gray-500 shadow-inner"></div>
                </div>
                <!-- The Arm Rod -->
                <div class="absolute top-16 left-1/2 transform -translate-x-1/2 w-2 h-40 bg-gradient-to-r from-gray-300 via-gray-100 to-gray-300 shadow-md"></div>
                <!-- Headshell -->
                <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 w-6 h-10 bg-gray-700 rounded-sm skew-x-12 origin-top"></div>
                <!-- Needle (Visual) -->
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-0.5 h-2 bg-yellow-600"></div>
            </div>
        </div>

        <!-- Controls Area -->
        <div class="flex flex-col w-full space-y-6">
            
            <!-- Song Info -->
            <div class="text-center md:text-left space-y-1">
                <h2 class="text-xs font-bold tracking-widest text-gray-400 uppercase">Now Playing</h2>
                <h1 id="track-title" class="text-xl md:text-2xl vintage-font text-gray-800 leading-tight line-clamp-2">Loading Vinyl...</h1>
                <p class="text-sm text-gray-500 italic font-light">Nordic Jazz Vibes</p>
            </div>

            <!-- Playback Controls -->
            <div class="flex items-center justify-center md:justify-start gap-6">
                <button id="prev-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="skip-back" class="w-6 h-6"></i>
                </button>
                
                <button id="play-btn" class="w-14 h-14 rounded-full bg-gray-800 text-[#f2f0eb] flex items-center justify-center shadow-lg hover:bg-gray-700 hover:scale-105 transition-all active:scale-95">
                    <i id="play-icon" data-lucide="play" class="w-6 h-6 fill-current ml-1"></i>
                </button>

                <button id="next-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="skip-forward" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Sliders -->
            <div class="space-y-4 pt-2">
                <!-- Music Volume -->
                <div class="flex items-center gap-3">
                    <i data-lucide="music" class="w-4 h-4 text-gray-400"></i>
                    <input type="range" id="volume-slider" min="0" max="100" value="80" class="flex-1">
                </div>
                
                <!-- Noise Generator Controls -->
                <div class="flex items-center gap-3 group">
                    <i data-lucide="waves" class="w-4 h-4 text-amber-600/70 group-hover:text-amber-700 transition-colors"></i>
                    <div class="flex-1 flex flex-col">
                        <div class="flex justify-between text-[10px] uppercase tracking-wider text-gray-400 mb-1">
                            <span>Analog Noise</span>
                            <span id="noise-label">25%</span>
                        </div>
                        <input type="range" id="noise-slider" min="0" max="100" value="25" class="flex-1">
                    </div>
                </div>
            </div>

            <!-- Status/Wake Lock Indicator -->
            <div class="flex justify-end pt-2">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-red-400 shadow-sm" title="Status"></div>
            </div>
        </div>
    </div>

    <!-- YouTube IFrame Container (Hidden visually but functional) -->
    <div id="player"></div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- Configuration ---
        // Jazz Livestream/Playlist IDs
        // UPDATED: Completely refreshed list using "Cafe Music BGM channel" and "Lofi Girl"
        // These are businesses built on allowing background play and embeds.
        const PLAYLIST = [
            'DWcJFNfaw9c', // Morning Jazz (Cafe Music BGM channel)
            'fEvM-OUbaKs', // Bossa Nova Jazz (Cafe Music BGM channel)
            '_4kL9JUwwZE', // Night Jazz (Cafe Music BGM channel)
            'hN_q-_nGv4U', // Relaxing Jazz (Cafe Music BGM channel)
            'jfKfPfyJRdk'  // Lofi Girl (Backup)
        ];
        let currentTrackIndex = 0;
        let consecutiveErrors = 0; // Prevent infinite error loops

        // --- YouTube API Setup ---
        let player;
        let isPlaying = false;
        
        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            const playerConfig = {
                height: '200',
                width: '200',
                videoId: PLAYLIST[currentTrackIndex],
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'rel': 0, // Don't show related videos from others
                    'iv_load_policy': 3 // Hide annotations
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            };

            // Only add origin if it is a valid HTTP/HTTPS protocol
            // This prevents issues with file:// or null origins in some sandbox environments
            if (window.location.protocol.startsWith('http')) {
                playerConfig.playerVars.origin = window.location.origin;
            }

            player = new YT.Player('player', playerConfig);
        }

        function onPlayerReady(event) {
            updateTrackInfo();
            // Start noise engine early but muted until play
            initAudioContext();
            consecutiveErrors = 0; // Reset error counter on success
            setLabelStatus(null); // Hide loading status
        }

        function onPlayerError(event) {
            console.error("YouTube Player Error:", event.data);
            
            // Increment error counter
            consecutiveErrors++;
            
            // Visual feedback
            setLabelStatus("Skipping...");

            // If we fail too many times (e.g., all tracks failed), stop trying
            if (consecutiveErrors >= PLAYLIST.length) {
                console.error("All tracks failed to load. Stopping.");
                setPlayingState(false);
                document.getElementById('track-title').textContent = "Playlist Unavailable";
                setLabelStatus("Error");
                return;
            }

            // If video fails, skip to next automatically with short delay
            setTimeout(() => {
                nextTrack();
            }, 1500);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                consecutiveErrors = 0; // Reset error counter on successful playback
                setPlayingState(true);
                setLabelStatus(null);
            } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
                setPlayingState(false);
            } else if (event.data == YT.PlayerState.BUFFERING) {
                setLabelStatus("Loading...");
            }
            
            // Update metadata if video changes
            if(player && player.getVideoData) {
                updateTrackInfo();
            }
        }

        // --- UI Logic & Animation ---
        const record = document.getElementById('record');
        const toneArm = document.getElementById('tone-arm');
        const playBtn = document.getElementById('play-btn');
        const playIcon = document.getElementById('play-icon');
        const albumArt = document.getElementById('album-art');
        const titleEl = document.getElementById('track-title');
        const statusDot = document.getElementById('status-dot');
        const labelStatus = document.getElementById('label-status');

        function setLabelStatus(text) {
            if (text) {
                labelStatus.textContent = text;
                labelStatus.classList.remove('hidden');
            } else {
                labelStatus.classList.add('hidden');
            }
        }

        function setPlayingState(playing) {
            isPlaying = playing;
            
            if (isPlaying) {
                // Visuals
                record.classList.add('spinning');
                record.classList.remove('paused-spin');
                toneArm.classList.add('playing');
                
                // Icon
                playBtn.innerHTML = '<i data-lucide="pause" class="w-6 h-6 fill-current"></i>';
                lucide.createIcons();

                // Status
                statusDot.classList.replace('bg-red-400', 'bg-green-400');
                statusDot.classList.add('animate-pulse');

                // Audio
                startNoise();
                requestWakeLock();
            } else {
                // Visuals
                record.classList.add('paused-spin');
                toneArm.classList.remove('playing');

                // Icon
                playBtn.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current ml-1"></i>';
                lucide.createIcons();

                // Status
                statusDot.classList.replace('bg-green-400', 'bg-red-400');
                statusDot.classList.remove('animate-pulse');

                // Audio
                stopNoise();
                releaseWakeLock();
            }
        }

        function updateTrackInfo() {
            if (!player || !player.getVideoData) return;
            const data = player.getVideoData();
            if (data && data.title) {
                titleEl.textContent = data.title;
                // Update thumbnail high res
                const newThumb = `https://i.ytimg.com/vi/${data.video_id}/hqdefault.jpg`;
                albumArt.src = newThumb;
            }
        }

        // --- Audio Noise Generator (Web Audio API) ---
        let audioCtx;
        let noiseGain;
        let masterGain;
        let noiseSource;

        function initAudioContext() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                setNoiseVolume(document.getElementById('noise-slider').value);
            }
        }

        /* * 日本語解説: ノイズ生成アルゴリズム
         * * 1. バッファの作成: 5秒間の空のオーディオバッファを作成します。
         * 2. ホワイトノイズ: Math.random() を使用して -1.0 から 1.0 の乱数を生成し、
         * これをヒスノイズのベースとします。
         * 3. クラックル（パチパチ音）: 非常に低い確率（0.05%程度）で、ランダムなタイミングで
         * 大きな振幅の値を挿入し、レコード特有の「プチッ」という音を再現します。
         * 4. ループ再生: 作成したバッファを AudioBufferSourceNode に設定し、ループ再生させます。
         * これにより、計算コストを抑えつつ持続的なアナログノイズを実現します。
         */
        function createVinylNoiseBuffer() {
            const bufferSize = audioCtx.sampleRate * 5; // 5 seconds loop
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                // Base Hiss (White noise) - Low amplitude
                const white = Math.random() * 2 - 1;
                data[i] = white * 0.05; 

                // Crackle (Random pops)
                // 1 in 2000 samples chance for a pop
                if (Math.random() < 0.0005) {
                    // Inject a sudden spike
                    data[i] += (Math.random() * 2 - 1) * 0.8;
                    // Decay rapidly for next few samples to create a "pop" envelope could be done here, 
                    // but single sample spikes often sound like dust pops enough.
                }
            }
            return buffer;
        }

        function startNoise() {
            if (!audioCtx) initAudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // If already playing, don't overlap
            if (noiseSource) return;

            const buffer = createVinylNoiseBuffer();
            noiseSource = audioCtx.createBufferSource();
            noiseSource.buffer = buffer;
            noiseSource.loop = true;
            
            // Create a LowPass filter to dampen the harsh white noise, making it "warmer"
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800; // Cut off high frequencies for "lo-fi" sound

            noiseSource.connect(filter);
            filter.connect(masterGain);
            noiseSource.start();
        }

        function stopNoise() {
            if (noiseSource) {
                noiseSource.stop();
                noiseSource.disconnect();
                noiseSource = null;
            }
        }

        function setNoiseVolume(val) {
            if (masterGain) {
                // Nonlinear fade for better control feeling
                // 0-100 input mapped to 0.0 - 0.15 max gain (noise shouldn't be too loud)
                const gain = (val / 100) * 0.15; 
                masterGain.gain.setTargetAtTime(gain, audioCtx.currentTime, 0.1);
            }
        }

        // --- Controls Event Listeners ---
        
        playBtn.addEventListener('click', () => {
            if (!player) return;
            // Resume Audio Context first (browser policy)
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

            if (isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        });

        document.getElementById('next-btn').addEventListener('click', nextTrack);
        document.getElementById('prev-btn').addEventListener('click', prevTrack);

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % PLAYLIST.length;
            loadTrack(currentTrackIndex);
        }

        function prevTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + PLAYLIST.length) % PLAYLIST.length;
            loadTrack(currentTrackIndex);
        }

        function loadTrack(index) {
            setLabelStatus("Loading...");
            if(player && player.loadVideoById) {
                player.loadVideoById(PLAYLIST[index]);
            }
        }

        // Sliders
        const volSlider = document.getElementById('volume-slider');
        volSlider.addEventListener('input', (e) => {
            if (player && player.setVolume) {
                player.setVolume(e.target.value);
            }
        });

        const noiseSlider = document.getElementById('noise-slider');
        noiseSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('noise-label').textContent = val + '%';
            setNoiseVolume(val);
        });

        // --- Wake Lock API ---
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock is active');
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release()
                    .then(() => { wakeLock = null; });
            }
        }

        // Rotation Speed Calculation Comment
        /* * 日本語解説: レコード回転速度の計算
         * * LPレコードの標準回転数は 33 1/3 RPM (Revolutions Per Minute) です。
         * これは1分間（60秒）に33.333...回回転することを意味します。
         * * 1回転にかかる時間 = 60秒 / 33.333... ≒ 1.8秒
         * * したがって、CSSアニメーションの duration は `1.8s` に設定しています。
         * :root { --record-speed: 1.8s; }
         */

    </script>
</body>
</html>
